# RÈGLES DE CONDUITE POUR L'AGENT (PROJET IFPEN.AllotropeConverters)

## 0. WORKFLOW DE DÉMARRAGE ET CARTE DU SAVOIR (OBLIGATOIRE)
- **Au début de chaque nouvelle session**, tu DOIS apprendre le contexte de l'application en lisant la documentation dans l'ordre suivant:
1. **`CONTEXT.md`**: Pour comprendre le domaine métier (Chromatographie, Allotrope, Chromeleon, etc.).
2. **`ARCHITECTURE.md`**: Pour comprendre comment le code est structuré.
3. **`DEVELOPMENT.md`**: Pour savoir comment build, et tester le code.
4. **`CURRENT_TASK.md`**
- Ce fichier contient ta mission actuelle. N'invente pas de nouvelles tâches tant que celles de `CURRENT_TASK.md` ne sont pas terminées.
- Une fois une tâche terminée, mets à jour le fichier `CURRENT_TASK.md` (en cochant la case [x]) avant de demander la validation au développeur.

## 1. Contraintes Techniques Absolues (NE JAMAIS ENFREINDRE)
- **Framework :** Le projet utilise EXCLUSIVEMENT .NET Framework 4.8.1 (`net481`). NE JAMAIS suggérer ou écrire du code .NET Core, .NET 5/6/7/8.
- **Plateforme :** La compilation cible STRICTEMENT `x86` (32-bit). N'utilise jamais `Any CPU` ou `x64` car le SDK Chromeleon est un composant COM 32-bit.
- **C# Version :** Utilise la syntaxe C# compatible avec .NET Framework (C# 7.3 par défaut, pas de Records, pas de pattern matching C# 11+).

## 2. Règle sur le SDK Propriétaire (Thermo.Chromeleon.Sdk)
- Le SDK est propriétaire. Tu n'as pas accès à sa documentation complète.
- **INTERDICTION D'HALLUCINER :** Si tu dois utiliser une interface du SDK (ex: `IInjection`, `ISignal`, `ISymbol`) que tu ne connais pas, DEMANDE d'abord au développeur ses propriétés et méthodes avant d'écrire le code.
- La gestion des scopes du SDK utilise `CmSdkScope`. Respecte le pattern `IDisposable` du code existant.

## 3. Architecture et Style de Code
- **Mappers :** Suis le pattern établi (Interfaces `IMapper` injectées dans le constructeur).
- **Exceptions :** Vérifie toujours la nullité des arguments en entrée (`ArgumentNullException`).
- **Documentation :** Ajoute des commentaires XML (`/// <summary>`) pour chaque méthode et classe publique.

## 4. Tests et TDD (Obligatoire)
- Écris les tests AVANT ou PENDANT l'écriture du code de production.
- **Tests Unitaires :** Utilise `xUnit`, `Moq`, `FluentAssertions`. Les interfaces Chromeleon doivent être mockées. Utilise les "Builders" existants (`InjectionBuilder`) pour créer tes données de test.
- **Tests d'Intégration (ATTENTION) :** Le SDK réel ne peut pas être instancié dans un process de test standard (`testhost.x86`) à cause de la vérification stricte du flag d'assembly `32BitsRequired`. Voir `DEVELOPMENT.md`.

## 5. Maintenance de la Documentation (Documentation-Driven Development)
- **Le code et la documentation doivent évoluer ensemble.** - Si tu modifies l'architecture, ajoutes un nouveau Mapper, changes une dépendance, ou modifies la façon dont on build/teste le projet, tu DOIS mettre à jour le fichier `.md` correspondant (`ARCHITECTURE.md`, `DEVELOPMENT.md`, etc.) dans le même commit.
- Considère qu'une tâche n'est pas "Terminée" tant que la documentation n'est pas alignée avec le code.

## 6. Protocole de Gestion des Issues et Workflow Git
- **Une Tâche = Une Branche :** Ne travaille jamais directement sur `main` ou `develop`. Crée systématiquement une branche dédiée au format : `type/description-courte` (ex: `fix/test-integration-sdk`, `feat/new-agilent-mapper`).
- **Règle de Non-Régression (TDD) :**
- Si tu résous un **Bug** : Tu DOIS d'abord écrire un test unitaire qui reproduit le bug et échoue (Red), avant d'écrire le correctif (Green). Ce test doit rester dans la codebase.
- Si tu ajoutes une **Feature** : Aucun code métier n'est accepté sans son test unitaire associé.
- **Commits Atomiques :** Fais des petits commits logiques avec des messages suivant la convention **Conventional Commits** (ex: `fix: handle null injection in mapper`, `docs: update deployment guide`).
- **Pull Requests (PR) :**
- Avant de signaler une tâche comme finie, vérifie que le projet compile et que TOUS les tests passent.
- La PR doit être propre : pas de code commenté inutile, pas de fichiers temporaires.
- La description de la PR doit résumer les changements techniques et lier l'issue concernée.
## 7. Nettoyage et Propreté
- **Self-Cleaning :** Tu DOIS supprimer tous les fichiers temporaires que tu as créés pendant ta session (fichiers de logs de build, rapports de tests `.trx` temporaires, fichiers de debug).
- Le repository doit rester propre à la fin de chaque tâche. Aucun fichier "déchet" ne doit être laissé dans la structure du projet.
